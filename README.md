# oktacar-lambda-vehicles
Vehicle inventory API for Oktacar demo. This Lambda is for demo purposes only, and is designed to work with this custom Lambda Authorizer:

https://github.com/bgarlow/oktacar-lambda-authorizer.git 

## Use Case

This Lambda function is intended to be used as a mock API endpoint(s) for an API deployed on AWS API Gateway. I can be used as the backend target for any of the resources configured on an. It is basically a debugging tool that will return in it's response any query string parameters passed to it as well as a host of information about the request context and context data passed in from the authorizer (see above) that secures it. The response (see below) includes info about the policy document that is generated by the authorizer, the decoded access token that was passed on the Authorization header, etc. 

When using this Lambda for an API endpoint, be sure to configure it as Integration type: Lambda Function, with Use Lambda Proxy integration selected.

## Deployment
### Install Dependencies

Run `npm install` to download all of the API's dependent modules. dependent modules. This is a prerequisite for deployment as AWS Lambda requires these files to be included in the uploaded bundle.

### Test locally with lambda-local

You can test the API locally using lambda-local and a local event.json file. Create a copy of the event-sample.json file, called event.json. Edit event.json for your environment and include a valid access token JWT.

You will also need to create a copy of .env_sample called .env. This file is used by the dotenv package to pull in environment variables from a file (.env). This project doesn't actually use the .env file, but the dependency is there because other related projects (like the authorizer) do.

Run `npm test` to run the API using the event.json file. Note that the local test will hit the local API directly, so the response JSON will be missing some context values that will be supplied by the authorizer when depolyed to the API gateway.

Response body:

```javascript  // compose our response body - this service is primarily returns information about the request context and the
    //  data passed in from the Lambda Authorizer.
    var responseBody = {
        mockingService: 'myTestService',
        description: 'This is a demo service designed to show the request context and data from our Lambda Authorizer. Below are the event and context passed to this API. Below those are the effect of the policy decision, the jwks from our auth server, and the claims presented in the access token consumed by the Lambda authorizer',
        requestParams: queryStringParams,
        event: event,
        context: context,
        token: token,
        effect: effectArray,
        jwks: jwks,
        claims: claims, 
    };
```

### Create Bundle

There are several ways to deploy this lambda to AWS. This document won't go into those details, but you will need a bundle, so:

Run `npm run bundle`. This will create mock-lambda-api.zip with all the source, configuration and node modules AWS Lambda needs.

## Sample Request and Response

```bash
curl -X GET \
  'https://zzz.execute-api.us-east-1.amazonaws.com/demo/banks?iban_value=GB32ESSE40486562136016&country_name=UNITED%20KINGDOM&iso_country_code=GB&iban_iso_country_code=GB' \
  -H 'Authorization: Bearer eyJraWQiOiJkRTVKbE4zWDdSN2E1aDFUZ1ZzTm1WYWpjWnZOSVBmMXFhMktZNjRmcWlRIiwiYWxnIjoiUlMyNTYifQ.zzz0ZZVUkiLCJpc3MiOiJodHRwczovL3NzbzMub2t0YWRvbW8uY29tL29hdXRoMi9hdXMyN29rYXNrVzR0a2hoWDJwNyIsImF1ZCI6IkZBQi5Db25zdW1lciIsImlhdCI6MTUzOTgwNzA4OSwiZXhwIjoxNTM5ODA3Mzg5LCJjaWQiOiIwb2EyN29mMjQyNEFQbEx5TTJwNyIsInNjcCI6WyJmYWI6cmVhZCJdLCJwcm9maWxlX2pzb24iOnsibmFtZUEiOiJ2YWx1ZUEiLCJuYW1lQiI6InZhbHVlQiJ9LCJzdWIiOiIwb2EyN29mMjQyNEFQbEx5TTJwNyIsInByb2ZpbGVfYXJyYXkiOlsidmFsdWVBIiwidmFsdWVCIl19.FHbQr_VkL6JWO0ZRZskGzkwXBttLO6kf-TAc_e5PUhltLbSQP769Vok2zSjx1axFtTdKMMs_I9udYW-yKI7RLZF5xo9bBE1Lq4u-X8rNy4LG9Jwfw-pCua1ONGqBnwo5JEd9RPEpY1srbXyxdwlMMDj9H4Uw6f2sgzIIJ5MZVL74Uw3MZCNtPGuzZIp9r7IlMeEu3z3iqQBnDc6Zuzh8H6s6Bs8dNwNs4gv2ymgr6GSSU_tKAKdC5MiC6PyJKGP45-HzsKW0TeWFnN7zF09VnSZqfnwAT3LignJU3Y4ettF7J0zEAryf6GkfAumw4EXI_6ZqZAoXOPiV0yN0oMp39Q' \
  -H 'Postman-Token: cf0cb360-55a8-433b-b4ae-c864127b3d2e' \
  -H 'cache-control: no-cache'
```

The response JSON below is from a deployed API on AWS API Gateway, and includes the Authorizer context data.
```json
{
    "mockingService": "myTestService",
    "description": "This is a demo service designed to show the request context and data from our Lambda Authorizer. Below are the event and context passed to this API. Below those are the effect of the policy decision, the jwks from our auth server, and the claims presented in the access token consumed by the Lambda authorizer",
    "requestParams": {
        "country_name": "UNITED KINGDOM",
        "iban_iso_country_code": "GB",
        "iban_value": "GB32ESSE40486562136016",
        "iso_country_code": "GB"
    },
    "event": {
        "resource": "/banks",
        "path": "/banks",
        "httpMethod": "GET",
        "headers": {
            "Accept": "*/*",
            "accept-encoding": "gzip, deflate",
            "Authorization": "Bearer eyJraWQiOiJkRTVKbE4zWDdSN2E1aDFUZ1ZzTm1WYWpjWnZOSVBmMXFhMktZNjRmcWlRIiwiYWxnIjoiUlMyNTYifQ.zzz0ZZVUkiLCJpc3MiOiJodHRwczovL3NzbzMub2t0YWRvbW8uY29tL29hdXRoMi9hdXMyN29rYXNrVzR0a2hoWDJwNyIsImF1ZCI6IkZBQi5Db25zdW1lciIsImlhdCI6MTUzOTgwNzA4OSwiZXhwIjoxNTM5ODA3Mzg5LCJjaWQiOiIwb2EyN29mMjQyNEFQbEx5TTJwNyIsInNjcCI6WyJmYWI6cmVhZCJdLCJwcm9maWxlX2pzb24iOnsibmFtZUEiOiJ2YWx1ZUEiLCJuYW1lQiI6InZhbHVlQiJ9LCJzdWIiOiIwb2EyN29mMjQyNEFQbEx5TTJwNyIsInByb2ZpbGVfYXJyYXkiOlsidmFsdWVBIiwidmFsdWVCIl19.FHbQr_VkL6JWO0ZRZskGzkwXBttLO6kf-TAc_e5PUhltLbSQP769Vok2zSjx1axFtTdKMMs_I9udYW-yKI7RLZF5xo9bBE1Lq4u-X8rNy4LG9Jwfw-pCua1ONGqBnwo5JEd9RPEpY1srbXyxdwlMMDj9H4Uw6f2sgzIIJ5MZVL74Uw3MZCNtPGuzZIp9r7IlMeEu3z3iqQBnDc6Zuzh8H6s6Bs8dNwNs4gv2ymgr6GSSU_tKAKdC5MiC6PyJKGP45-HzsKW0TeWFnN7zF09VnSZqfnwAT3LignJU3Y4ettF7J0zEAryf6GkfAumw4EXI_6ZqZAoXOPiV0yN0oMp39Q",
            "cache-control": "no-cache",
            "Host": "0vacknstyf.execute-api.us-east-1.amazonaws.com",
            "Postman-Token": "1a12645d-6790-4b41-afb5-04c3c493ecc9",
            "User-Agent": "PostmanRuntime/7.3.0",
            "X-Amzn-Trace-Id": "Root=1-5bc7977f-ccec87a62eb199f1fd0b5c7f",
            "X-Forwarded-For": "73.95.165.213",
            "X-Forwarded-Port": "443",
            "X-Forwarded-Proto": "https"
        },
        "multiValueHeaders": {
            "Accept": [
                "*/*"
            ],
            "accept-encoding": [
                "gzip, deflate"
            ],
            "Authorization": [
                "Bearer eyJraWQiOiJkRTVKbE4zWDdSN2E1aDFUZ1ZzTm1WYWpjWnZOSVBmMXFhMktZNjRmcWlRIiwiYWxnIjoiUlMyNTYifQ.zzz0ZZVUkiLCJpc3MiOiJodHRwczovL3NzbzMub2t0YWRvbW8uY29tL29hdXRoMi9hdXMyN29rYXNrVzR0a2hoWDJwNyIsImF1ZCI6IkZBQi5Db25zdW1lciIsImlhdCI6MTUzOTgwNzA4OSwiZXhwIjoxNTM5ODA3Mzg5LCJjaWQiOiIwb2EyN29mMjQyNEFQbEx5TTJwNyIsInNjcCI6WyJmYWI6cmVhZCJdLCJwcm9maWxlX2pzb24iOnsibmFtZUEiOiJ2YWx1ZUEiLCJuYW1lQiI6InZhbHVlQiJ9LCJzdWIiOiIwb2EyN29mMjQyNEFQbEx5TTJwNyIsInByb2ZpbGVfYXJyYXkiOlsidmFsdWVBIiwidmFsdWVCIl19.FHbQr_VkL6JWO0ZRZskGzkwXBttLO6kf-TAc_e5PUhltLbSQP769Vok2zSjx1axFtTdKMMs_I9udYW-yKI7RLZF5xo9bBE1Lq4u-X8rNy4LG9Jwfw-pCua1ONGqBnwo5JEd9RPEpY1srbXyxdwlMMDj9H4Uw6f2sgzIIJ5MZVL74Uw3MZCNtPGuzZIp9r7IlMeEu3z3iqQBnDc6Zuzh8H6s6Bs8dNwNs4gv2ymgr6GSSU_tKAKdC5MiC6PyJKGP45-HzsKW0TeWFnN7zF09VnSZqfnwAT3LignJU3Y4ettF7J0zEAryf6GkfAumw4EXI_6ZqZAoXOPiV0yN0oMp39Q"
            ],
            "cache-control": [
                "no-cache"
            ],
            "Host": [
                "0vacknstyf.execute-api.us-east-1.amazonaws.com"
            ],
            "Postman-Token": [
                "1a12645d-6790-4b41-afb5-04c3c493ecc9"
            ],
            "User-Agent": [
                "PostmanRuntime/7.3.0"
            ],
            "X-Amzn-Trace-Id": [
                "Root=1-5bc7977f-ccec87a62eb199f1fd0b5c7f"
            ],
            "X-Forwarded-For": [
                "73.95.165.213"
            ],
            "X-Forwarded-Port": [
                "443"
            ],
            "X-Forwarded-Proto": [
                "https"
            ]
        },
        "queryStringParameters": {
            "country_name": "UNITED KINGDOM",
            "iban_iso_country_code": "GB",
            "iban_value": "GB32ESSE40486562136016",
            "iso_country_code": "GB"
        },
        "multiValueQueryStringParameters": {
            "country_name": [
                "UNITED KINGDOM"
            ],
            "iban_iso_country_code": [
                "GB"
            ],
            "iban_value": [
                "GB32ESSE40486562136016"
            ],
            "iso_country_code": [
                "GB"
            ]
        },
        "pathParameters": null,
        "stageVariables": null,
        "requestContext": {
            "resourceId": "5i1j5i",
            "authorizer": {
                "audience": "FAB.Consumer",
                "awsAccountId": "350244277973",
                "jwks": "see jwks attribute below...",
                "method": "GET",
                "resource": "arn:aws:execute-api:us-east-1:350244277973:0vacknstyf/demo/GET/banks arn:aws:execute-api:us-east-1:350244277973:0vacknstyf/demo/HEAD/banks arn:aws:execute-api:us-east-1:350244277973:0vacknstyf/demo/OPTIONS/banks",
                "apiResource": "/banks",
                "principalId": "0oa27of2424APlLyM2p7",
                "version": "2012-10-17",
                "issuer": "https://sso3.oktadomo.com/oauth2/aus27okaskW4tkhhX2p7",
                "authorizerMessage": "",
                "restApiId": "0vacknstyf",
                "effect": "see effect attribute below...",
                "claims": "see token attribute below...",
                "action": "execute-api:Invoke",
                "state": "demo",
                "scopes": "fab:read",
                "region": "us-east-1"
            },
            "resourcePath": "/banks",
            "httpMethod": "GET",
            "extendedRequestId": "O7Sb2FzMoAMFWHQ=",
            "requestTime": "17/Oct/2018:20:11:43 +0000",
            "path": "/demo/banks",
            "accountId": "350244277973",
            "protocol": "HTTP/1.1",
            "stage": "demo",
            "requestTimeEpoch": 1539807103076,
            "requestId": "dd85026b-d248-11e8-8a1f-4b082737bc2b",
            "identity": {
                "cognitoIdentityPoolId": null,
                "accountId": null,
                "cognitoIdentityId": null,
                "caller": null,
                "sourceIp": "73.95.165.213",
                "accessKey": null,
                "cognitoAuthenticationType": null,
                "cognitoAuthenticationProvider": null,
                "userArn": null,
                "userAgent": "PostmanRuntime/7.3.0",
                "user": null
            },
            "apiId": "0vacknstyf"
        },
        "body": null,
        "isBase64Encoded": false
    },
    "context": {
        "callbackWaitsForEmptyEventLoop": true,
        "logGroupName": "/aws/lambda/mockApiLambda",
        "logStreamName": "2018/10/17/[$LATEST]ba7eeed9958e410bbb2498e6c53385cc",
        "functionName": "mockApiLambda",
        "memoryLimitInMB": "128",
        "functionVersion": "$LATEST",
        "invokeid": "de351884-d248-11e8-af43-5d96c7ad21d2",
        "awsRequestId": "de351884-d248-11e8-af43-5d96c7ad21d2",
        "invokedFunctionArn": "arn:aws:lambda:us-east-1:350244277973:function:mockApiLambda"
    },
    "token": {
        "header": {
            "kid": "dE5JlN3X7R7a5h1TgVsNmVajcZvNIPf1qa2KY64fqiQ",
            "alg": "RS256"
        },
        "payload": {
            "ver": 1,
            "jti": "AT.d03CdmquW3HNviHghbDWgUphZ0uiUDEV7TfC8VWFYUI",
            "iss": "https://sso3.oktadomo.com/oauth2/aus27okaskW4tkhhX2p7",
            "aud": "FAB.Consumer",
            "iat": 1539807089,
            "exp": 1539807389,
            "cid": "0oa27of2424APlLyM2p7",
            "scp": [
                "fab:read"
            ],
            "profile_json": {
                "nameA": "valueA",
                "nameB": "valueB"
            },
            "sub": "0oa27of2424APlLyM2p7",
            "profile_array": [
                "valueA",
                "valueB"
            ]
        },
        "signature": "FHbQr_VkL6JWO0ZRZskGzkwXBttLO6kf-TAc_e5PUhltLbSQP769Vok2zSjx1axFtTdKMMs_I9udYW-yKI7RLZF5xo9bBE1Lq4u-X8rNy4LG9Jwfw-pCua1ONGqBnwo5JEd9RPEpY1srbXyxdwlMMDj9H4Uw6f2sgzIIJ5MZVL74Uw3MZCNtPGuzZIp9r7IlMeEu3z3iqQBnDc6Zuzh8H6s6Bs8dNwNs4gv2ymgr6GSSU_tKAKdC5MiC6PyJKGP45-HzsKW0TeWFnN7zF09VnSZqfnwAT3LignJU3Y4ettF7J0zEAryf6GkfAumw4EXI_6ZqZAoXOPiV0yN0oMp39Q"
    },
    "effect": [
        "Allow"
    ],
    "jwks": {
        "keys": [
            {
                "kty": "RSA",
                "alg": "RS256",
                "kid": "dE5JlN3X7R7a5h1TgVsNmVajcZvNIPf1qa2KY64fqiQ",
                "use": "sig",
                "e": "AQAB",
                "n": "o1KvVlqacsH0_yhb1St-4nmgJDhzXvA78GgsEi8sIv01P20npWp827W6rYjBiOHE13XtQv-4tKvDDMVm_0Si9_ck0jeZzZgdGmDO3e1udW1ZgBaL4HZQCESzNVa7SPwme3y1JAlCKUBOw5k2BPA0XmFcbm23bnqRCUkJk6YUKCyYTIH_6Qr7wb9NNVJ_t_g4pJcx7nd6sTyQ6QHL-e_FXZM2hoUjGpbyvBHK7e1dzZPTP5qArfwt2B5TPOrQQTl3bsgnWy16dbjJwViomMHC3jXqPat09KUcg75_50zbD9_rEsM2hIt2XXsE_Jv4M-CChT8RocvUIUwzu7KKsKpB3Q"
            }
        ]
    },
    "claims": {
        "ver": 1,
        "jti": "AT.d03CdmquW3HNviHghbDWgUphZ0uiUDEV7TfC8VWFYUI",
        "iss": "https://sso3.oktadomo.com/oauth2/aus27okaskW4tkhhX2p7",
        "aud": "FAB.Consumer",
        "iat": 1539807089,
        "exp": 1539807389,
        "cid": "0oa27of2424APlLyM2p7",
        "scp": [
            "fab:read"
        ],
        "profile_json": {
            "nameA": "valueA",
            "nameB": "valueB"
        },
        "sub": "0oa27of2424APlLyM2p7",
        "profile_array": [
            "valueA",
            "valueB"
        ]
    }
}

```